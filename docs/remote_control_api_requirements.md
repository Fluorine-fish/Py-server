# 远程控制功能后端API需求文档

## 概述
本文档描述了台灯远程控制页面所需的后端API接口，用于实现台灯的远程控制和护眼设置功能。

## API接口列表

### 1. 获取台灯状态
**接口地址：** `GET /api/lamp/status`

**功能描述：** 获取台灯当前的状态信息

**请求参数：** 无

**响应数据：**
```json
{
    "success": true,
    "data": {
        "powerOn": true,         // 电源状态：true=开启，false=关闭
        "lightOn": true,         // 灯光状态：true=开启，false=关闭
        "brightness": 500,       // 当前亮度：0-1000
        "temperature": 5300,     // 当前色温：3000-6500K
        "connectionStatus": "connected"  // 连接状态
    }
}
```

### 2. 设置台灯灯光参数
**接口地址：** `POST /api/lamp/settings`

**功能描述：** 设置台灯的亮度和色温

**请求参数：**
```json
{
    "brightness": 500,    // 亮度值：0-1000
    "temperature": 5300,  // 色温值：3000-6500K
    "command": 22         // 串口命令字：0x16 (22)
}
```

**响应数据：**
```json
{
    "success": true,
    "message": "设置成功",
    "data": {
        "brightness": 500,
        "temperature": 5300
    }
}
```

**串口协议实现：**
- 使用命令字 `0x16` 直接设置灯光
- 数据域：
  - `data[0]`: 亮度高8位
  - `data[1]`: 亮度低8位  
  - `data[2]`: 色温高8位
  - `data[3]`: 色温低8位

### 3. 发送串口控制命令
**接口地址：** `POST /api/serial/command`

**功能描述：** 发送基础控制命令到台灯

**请求参数：**
```json
{
    "command": 0  // 命令字，对应串口通讯协议中的命令
}
```

**支持的命令字：**
- `0x00`: 上位机开机
- `0x01`: 上位机关机
- `0x02`: 回到复位状态
- `0x10`: 提高光照亮度
- `0x11`: 降低光照亮度
- `0x12`: 提升光照色温
- `0x13`: 降低光照色温
- `0x14`: 开灯
- `0x15`: 关灯
- `0x20`: 进行坐姿提醒
- `0x21`: 进行远眺提醒

**响应数据：**
```json
{
    "success": true,
    "message": "命令发送成功",
    "command": 0
}
```

### 4. 保存护眼设置
**接口地址：** `POST /api/eyecare/settings`

**功能描述：** 保存护眼提醒相关设置

**请求参数：**
```json
{
    "restInterval": 20,        // 远眺休息间隔（分钟）
    "eyeStrainLimit": 45,      // 长时间用眼提醒阈值（分钟）
    "reminderOptions": [       // 提醒方式
        "灯光闪烁提醒",
        "语音提醒"
    ]
}
```

**响应数据：**
```json
{
    "success": true,
    "message": "护眼设置保存成功"
}
```

### 5. 获取护眼设置
**接口地址：** `GET /api/eyecare/settings`

**功能描述：** 获取当前的护眼设置

**请求参数：** 无

**响应数据：**
```json
{
    "success": true,
    "data": {
        "restInterval": 20,
        "eyeStrainLimit": 45,
        "reminderOptions": [
            "灯光闪烁提醒",
            "语音提醒"
        ]
    }
}
```

## 串口数据处理

### 下位机状态上报处理
当接收到下位机的状态上报数据（消息类型 `0xB0`）时，需要解析以下数据：

**数据域解析：**
- `data[0]`: 是否开机（0=关机，1=开机）
- `data[1]`: 是否开灯（0=关灯，1=开灯）
- `data[2]`: 光照亮度（0-1000）
- `data[3]`: 光照色温（3000-6500K）

**实现要求：**
1. 解析串口数据并更新内部状态
2. 可通过WebSocket实时推送状态变化到前端
3. 支持前端定时轮询获取最新状态

### 命令发送实现
**数据包格式：**
```
开始字符: 's' (0x73)
消息类型: 0xA0 (上位机控制下位机)
命令字: 具体命令值
数据域: 8个uint32_t值（共32字节）
结束字符: 'e' (0x65)
```

**特殊命令实现：**
- 使用命令字 `0x16` 设置灯光时：
  - 需要将亮度值拆分为高8位和低8位
  - 需要将色温值拆分为高8位和低8位
  - 其他数据域填充0

## 错误处理

### 错误响应格式
```json
{
    "success": false,
    "error": "错误描述",
    "code": "ERROR_CODE"
}
```

### 常见错误码
- `SERIAL_ERROR`: 串口通讯错误
- `INVALID_PARAMS`: 参数错误
- `DEVICE_OFFLINE`: 设备离线
- `TIMEOUT`: 操作超时

## 实现建议

1. **状态同步**：建议使用WebSocket实现实时状态同步
2. **错误重试**：对于串口通讯失败的情况，建议实现自动重试机制
3. **参数验证**：严格验证亮度（0-1000）和色温（3000-6500K）的范围
4. **日志记录**：记录所有控制命令和状态变化，便于调试和监控
5. **权限控制**：考虑添加必要的权限验证机制

## 前端已实现功能

1. **仪表盘显示**：实时显示台灯亮度和色温状态，带有CSS动画效果
2. **灯光控制**：提供电源开关、灯光开关、亮度调节、色温调节功能
3. **快捷按钮**：预设常用的亮度和色温值
4. **护眼设置**：远眺休息间隔、长时间用眼提醒设置
5. **护眼小贴士**：提供护眼相关的建议和提示
6. **实时更新**：支持通过用户操作和服务器数据两种方式更新显示
7. **响应式设计**：适配不同屏幕尺寸
